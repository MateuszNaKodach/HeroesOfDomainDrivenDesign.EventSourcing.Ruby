<%= form_with(url: recruit_heroes_game_creature_recruitment_dwelling_path(@dwelling.game_id, @dwelling), local: true, method: :post, id: 'recruit-form', class: 'recruitment') do |form| %>
  <%= render_dwelling(@dwelling, form) %>
  <%= render 'heroes/calendar/current_date' %>
  <%= form.hidden_field :recruit_count, id: 'recruit-count-input' %>
<% end %>

<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        const slider = document.getElementById('recruit-slider');
        const recruitCount = document.getElementById('recruit-count');
        const selectAllBtn = document.getElementById('select-all-btn');
        const recruitBtn = document.getElementById('recruit-btn');
        const recruitForm = document.getElementById('recruit-form');
        const recruitCountInput = document.getElementById('recruit-count-input');
        const messageBox = document.querySelector('.recruitment__message-box__text');

        function updateTotalCost(count) {
            <% @dwelling.cost_per_troop['resources'].each do |resource, amount| %>
            document.getElementById('total-<%= resource.downcase %>').textContent = count * <%= amount %>;
            <% end %>
        }

        function updateRecruitCount(count) {
            recruitCount.textContent = count;
            updateTotalCost(count);
        }

        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.classList.toggle('recruitment__message-box__text--error', isError);
            messageBox.style.display = 'block';
        }

        // Initialize with 0
        updateRecruitCount(0);

        slider.addEventListener('input', function() {
            const count = parseInt(this.value);
            updateRecruitCount(count);
        });

        selectAllBtn.addEventListener('click', function() {
            slider.value = <%= @dwelling.available_creatures %>;
            updateRecruitCount(<%= @dwelling.available_creatures %>);
        });

        recruitBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const count = parseInt(slider.value);
            if (count === 0) {
                showMessage("Please select at least one creature to recruit.", true);
            } else {
                recruitCountInput.value = count;
                recruitForm.submit();
            }
        });

        // Display flash message if present
        <% flash.each do |type, message| %>
        showMessage("<%= j message %>", <%= type == 'alert' %>);
        <% end %>
    });
</script>